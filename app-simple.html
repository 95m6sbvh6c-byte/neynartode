<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neynartodes - Simple Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-b from-purple-500 to-blue-500 min-h-screen">
  <div id="app" class="container mx-auto p-8">
    <div class="bg-white rounded-3xl shadow-2xl p-12 text-center max-w-2xl mx-auto">
      <div class="text-6xl mb-6">ü¶é</div>
      <h1 class="text-4xl font-black text-purple-600 mb-4">Danng Neynartodes!!</h1>
      <p class="text-xl text-gray-700 mb-8">Season 0 Beta Platform</p>

      <div id="status" class="mb-6 p-4 bg-blue-50 rounded-xl">
        <p class="text-sm text-blue-800">Checking wallet...</p>
      </div>

      <button
        id="connectBtn"
        class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-8 py-4 rounded-2xl font-bold text-lg transition-all shadow-lg"
      >
        üëõ Connect Wallet
      </button>

      <div id="info" class="mt-8 p-4 bg-purple-50 rounded-xl">
        <p class="text-sm font-semibold text-purple-800 mb-2">Requirements:</p>
        <ul class="text-xs text-purple-700 text-left space-y-1">
          <li>‚úì Base network</li>
          <li>‚úì 20,000 NEYNARTODES tokens</li>
          <li>‚úì Season 0 whitelist (74 testers)</li>
        </ul>
      </div>

      <div id="leaderboard" class="mt-8 hidden">
        <h2 class="text-2xl font-black text-purple-800 mb-4">üèÜ Leaderboard Loading...</h2>
        <div id="userList" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>

  <script>
    console.log('Simple app loaded!');
    console.log('ethers:', typeof ethers);

    const CONTRACTS = {
      prizeNFT: '0x82f5A8CEffce9419886Bb0644FA5D3FB8295Ab81',
      votingManager: '0xFF730AB8FaBfc432c513C57bE8ce377ac77eEc99',
      neynartodes: '0x8de1622fe07f56cda2e2273e615a513f1d828b07',
    };

    const NEYNAR_API_KEY = 'AA2E0FC2-FDC0-466D-9EBA-4BCA968C9B1D';
    const BASE_RPC = 'https://mainnet.base.org';

    const TOKEN_GATE = '20000';

    document.getElementById('status').innerHTML = '<p class="text-sm text-green-800">‚úÖ App loaded! Click connect button.</p>';

    document.getElementById('connectBtn').addEventListener('click', async () => {
      console.log('Connect button clicked');

      if (!window.ethereum) {
        alert('Please install MetaMask!');
        return;
      }

      try {
        document.getElementById('status').innerHTML = '<p class="text-sm text-blue-800">üîÑ Connecting wallet...</p>';

        const provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        const signer = await provider.getSigner();
        const address = await signer.getAddress();

        console.log('Connected:', address);
        document.getElementById('status').innerHTML = `<p class="text-sm text-green-800">‚úÖ Connected: ${address.slice(0, 6)}...${address.slice(-4)}</p>`;

        // Check token balance
        const tokenContract = new ethers.Contract(
          CONTRACTS.neynartodes,
          ['function balanceOf(address) external view returns (uint256)'],
          provider
        );

        const balance = await tokenContract.balanceOf(address);
        const formatted = ethers.formatEther(balance);
        console.log('Token balance:', formatted);

        // Check whitelist
        const prizeNFTContract = new ethers.Contract(
          CONTRACTS.prizeNFT,
          ['function whitelist(address) external view returns (bool)'],
          provider
        );

        const whitelisted = await prizeNFTContract.whitelist(address);
        console.log('Whitelisted:', whitelisted);

        const required = ethers.parseEther(TOKEN_GATE);
        const hasTokens = balance >= required;

        if (hasTokens && whitelisted) {
          document.getElementById('status').innerHTML = `
            <p class="text-sm text-green-800 font-bold">‚úÖ ACCESS GRANTED!</p>
            <p class="text-xs text-gray-600 mt-1">Balance: ${parseFloat(formatted).toLocaleString()} NEYNARTODES</p>
          `;

          // Load leaderboard
          loadLeaderboard();
        } else {
          const reason = !whitelisted
            ? 'Not whitelisted for Season 0 Beta'
            : `Need ${TOKEN_GATE} tokens (you have ${parseFloat(formatted).toFixed(0)})`;

          document.getElementById('status').innerHTML = `
            <p class="text-sm text-red-800 font-bold">üö´ Access Denied</p>
            <p class="text-xs text-gray-600 mt-1">${reason}</p>
          `;
        }

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('status').innerHTML = `
          <p class="text-sm text-red-800">‚ùå Error: ${error.message}</p>
        `;
      }
    });

    async function loadLeaderboard() {
      console.log('Loading leaderboard...');
      document.getElementById('leaderboard').classList.remove('hidden');

      const WHITELIST_FIDS = [1020, 10956, 202051, 217530, 280534];
      const fidsParam = WHITELIST_FIDS.join(',');

      try {
        const response = await fetch(
          `https://api.neynar.com/v2/farcaster/user/bulk?fids=${fidsParam}`,
          {
            headers: {
              'api_key': NEYNAR_API_KEY,
            },
          }
        );

        const data = await response.json();
        console.log('Neynar data:', data);

        if (data.users) {
          const userList = document.getElementById('userList');
          userList.innerHTML = '';

          data.users.slice(0, 5).forEach((user, idx) => {
            const div = document.createElement('div');
            div.className = 'p-3 bg-purple-50 rounded-lg flex items-center gap-3';
            div.innerHTML = `
              <span class="font-bold text-purple-600">#${idx + 1}</span>
              <img src="${user.pfp_url}" class="w-10 h-10 rounded-full" />
              <div class="flex-1 text-left">
                <p class="font-semibold text-gray-800">@${user.username}</p>
                <p class="text-xs text-gray-600">${user.follower_count} followers</p>
              </div>
            `;
            userList.appendChild(div);
          });

          document.getElementById('leaderboard').innerHTML = `
            <h2 class="text-2xl font-black text-purple-800 mb-4">üèÜ Top Beta Testers</h2>
            ${userList.outerHTML}
          `;
        }

      } catch (error) {
        console.error('Error loading leaderboard:', error);
        document.getElementById('leaderboard').innerHTML = '<p class="text-red-600">Failed to load leaderboard</p>';
      }
    }

    console.log('App initialized');
  </script>
</body>
</html>
