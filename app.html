<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danng Neynartodes!! - Season 0 Beta</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    .animate-bounce {
      animation: bounce 2s infinite;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURATION - SEASON 0 BETA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const NEYNAR_API_KEY = 'AA2E0FC2-FDC0-466D-9EBA-4BCA968C9B1D';
    const NEYNAR_BASE_URL = 'https://api.neynar.com/v2/farcaster';

    const CONTRACTS = {
      prizeNFT: '0x82f5A8CEffce9419886Bb0644FA5D3FB8295Ab81',
      votingManager: '0xFF730AB8FaBfc432c513C57bE8ce377ac77eEc99',
      clankerCollector: '0xAcFC2aD738599f5E5F0B90B11774b279eb2CF280',
      captainHook: '0x38A6C6074f4E14c82dB3bdDe4cADC7Eb2967fa9B',
      treasury: '0xB5A1a3AAD5962dBF2B8DF3C5712d137c1640A176',
      neynartodes: '0x8de1622fe07f56cda2e2273e615a513f1d828b07',
    };

    const TOKEN_GATE = '20000';

    const WHITELIST_FIDS = [
      1020, 10956, 202051, 217530, 280534, 368206, 466345, 473136,
      655816, 918820, 1009822, 1188162, 1328864, 8425, 16538, 191870,
      191933, 208744, 217695, 239249, 244344, 250003, 250084, 255153,
      257004, 268567, 277673, 291258, 303218, 332768, 384418, 403173,
      403845, 410577, 418419, 460229, 460627, 484444, 493501, 499575,
      516336, 548258, 560260, 764587, 843635, 851606, 882521, 883491,
      916167, 921736, 924978, 926344, 932195, 978603, 978640, 1024904,
      1045847, 1106257, 1108825, 1109570, 1149403, 1163132, 1278135,
      1336727, 1363858, 1383575, 1400301, 1418938, 1419659, 1419944,
      1439709, 1445897, 1448496
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let state = {
      isLoggedIn: false,
      userAddress: '',
      tokenBalance: '0',
      isWhitelisted: false,
      hasAccess: false,
      userProfile: null,
      leaderboardData: [],
      isLoadingLeaderboard: false,
      votesRemaining: 10,
      votesUsedToday: 0
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WALLET CONNECTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function connectWallet() {
      if (!window.ethereum) {
        alert('Please install MetaMask!');
        return;
      }

      try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        const signer = await provider.getSigner();
        const address = await signer.getAddress();

        state.userAddress = address;

        // Check token balance
        const tokenContract = new ethers.Contract(
          CONTRACTS.neynartodes,
          ['function balanceOf(address) external view returns (uint256)'],
          provider
        );

        const balance = await tokenContract.balanceOf(address);
        const formatted = ethers.formatEther(balance);
        state.tokenBalance = formatted;

        // Check whitelist
        const prizeNFTContract = new ethers.Contract(
          CONTRACTS.prizeNFT,
          ['function whitelist(address) external view returns (bool)'],
          provider
        );

        const whitelisted = await prizeNFTContract.whitelist(address);
        state.isWhitelisted = whitelisted;

        const required = ethers.parseEther(TOKEN_GATE);
        const hasTokens = balance >= required;

        if (hasTokens && whitelisted) {
          state.hasAccess = true;
          state.isLoggedIn = true;

          await fetchFarcasterProfile(address);
          await loadLeaderboard();
          renderApp();
        } else {
          const reason = !whitelisted
            ? 'You are not whitelisted for Season 0 Beta (74 testers only)'
            : `You need ${TOKEN_GATE} NEYNARTODES tokens (you have ${parseFloat(formatted).toFixed(0)})`;
          alert(`ğŸš« Access Denied!\n\n${reason}`);
        }

      } catch (error) {
        console.error('Error connecting wallet:', error);
        alert('Failed to connect wallet. Make sure you're on Base network!');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NEYNAR API
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function fetchFarcasterProfile(address) {
      try {
        const response = await fetch(
          `${NEYNAR_BASE_URL}/user/bulk-by-address?addresses=${address}`,
          { headers: { 'api_key': NEYNAR_API_KEY } }
        );

        const data = await response.json();
        if (data && data[address] && data[address][0]) {
          state.userProfile = data[address][0];
        }
      } catch (error) {
        console.error('Error fetching Farcaster profile:', error);
      }
    }

    async function loadLeaderboard() {
      state.isLoadingLeaderboard = true;
      renderApp();

      try {
        const batchSize = 100;
        let allUsers = [];

        for (let i = 0; i < WHITELIST_FIDS.length; i += batchSize) {
          const batch = WHITELIST_FIDS.slice(i, i + batchSize);
          const fidsParam = batch.join(',');

          const response = await fetch(
            `${NEYNAR_BASE_URL}/user/bulk?fids=${fidsParam}`,
            { headers: { 'api_key': NEYNAR_API_KEY } }
          );

          const data = await response.json();
          if (data.users) {
            allUsers = allUsers.concat(data.users);
          }
        }

        state.leaderboardData = allUsers.map((user, idx) => ({
          rank: idx + 1,
          fid: user.fid,
          pfp: user.pfp_url || 'ğŸ¦',
          username: user.username,
          displayName: user.display_name,
          followers: user.follower_count || 0,
          following: user.following_count || 0,
          totalScore: (user.follower_count || 0) * 10,
          voteScore: 0
        }));

        state.leaderboardData.sort((a, b) => b.totalScore - a.totalScore);
        state.leaderboardData.forEach((user, idx) => {
          user.rank = idx + 1;
        });

      } catch (error) {
        console.error('Error loading leaderboard:', error);
        alert('Failed to load leaderboard');
      } finally {
        state.isLoadingLeaderboard = false;
        renderApp();
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VOTING - CONNECTED TO BLOCKCHAIN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function voteForHost(hostFid, isUpvote) {
      if (state.votesRemaining <= 0) {
        alert('You have used all 10 votes for today!');
        return;
      }

      try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();

        const votingManagerABI = [
          'function vote(uint256 contestId, uint256 candidateFid, bool isUpvote) external'
        ];

        const votingContract = new ethers.Contract(
          CONTRACTS.votingManager,
          votingManagerABI,
          signer
        );

        const votedHost = state.leaderboardData.find(h => h.fid === hostFid);
        alert(`Submitting ${isUpvote ? 'ğŸ‘ Upvote' : 'ğŸ‘ Downvote'} for @${votedHost.username}...\n\nPlease confirm in MetaMask.`);

        const tx = await votingContract.vote(0, hostFid, isUpvote);
        alert(`â³ Transaction submitted!\n\nWaiting for confirmation...\nTx: ${tx.hash.slice(0, 10)}...`);

        await tx.wait();

        // Update local state
        const votePoints = isUpvote ? 5000 : -5000;
        state.leaderboardData = state.leaderboardData.map(host => {
          if (host.fid === hostFid) {
            return {
              ...host,
              voteScore: host.voteScore + votePoints,
              totalScore: host.totalScore + votePoints
            };
          }
          return host;
        }).sort((a, b) => b.totalScore - a.totalScore);

        state.leaderboardData.forEach((user, idx) => {
          user.rank = idx + 1;
        });

        state.votesUsedToday++;
        state.votesRemaining--;

        renderApp();

        alert(`âœ… Vote confirmed on-chain!\n\n${isUpvote ? 'ğŸ‘ Upvote' : 'ğŸ‘ Downvote'} for @${votedHost.username}\n\nVotes remaining: ${state.votesRemaining}/10\n\nTx: ${tx.hash}`);

      } catch (error) {
        console.error('Error voting:', error);

        if (error.code === 'ACTION_REJECTED') {
          alert('âŒ Transaction cancelled.');
        } else if (error.message.includes('MAX_VOTES_PER_DAY')) {
          alert('âŒ Maximum votes reached for today!');
        } else {
          alert(`âŒ Failed to vote:\n\n${error.message}`);
        }
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDERING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderLoginScreen() {
      return `
        <div class="min-h-screen bg-gradient-to-b from-blue-400 via-purple-500 to-blue-900 flex items-center justify-center p-6 relative overflow-hidden">
          <div class="bg-white rounded-3xl shadow-2xl p-12 max-w-md w-full text-center relative z-10 border-4 border-purple-400">
            <div class="mb-6">
              <div class="text-7xl mb-4 animate-bounce">ğŸ¦</div>
              <h1 class="text-5xl font-black mb-3" style="background: linear-gradient(45deg, #9333ea, #ec4899, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                Danng<br/>Neynartodes!!
              </h1>
              <p class="text-purple-600 font-bold text-sm">ğŸŒŠ Season 0 Beta Platform ğŸŒŠ</p>
            </div>

            <div class="mb-6 p-4 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl border-2 border-purple-300">
              <div class="text-2xl mb-2">ğŸ”’</div>
              <p class="text-sm font-black text-purple-800 mb-1">SEASON 0 BETA</p>
              <p class="text-xs text-purple-700 font-semibold">74 Whitelisted Testers | 20K Token Gate</p>
            </div>

            <button
              onclick="connectWallet()"
              class="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-purple-500 via-pink-500 to-purple-600 hover:from-purple-600 hover:via-pink-600 hover:to-purple-700 text-white px-6 py-5 rounded-2xl font-black text-xl transition-all shadow-lg mb-4 transform hover:scale-105 border-2 border-purple-300"
            >
              <span class="text-2xl">ğŸ‘›</span>
              Connect Wallet
            </button>

            <div class="mt-8 p-4 bg-purple-50 rounded-xl border-2 border-purple-200">
              <p class="text-sm text-purple-800 mb-2 font-semibold">ğŸ“‹ Season 0 Requirements:</p>
              <ul class="text-xs text-purple-700 space-y-1 text-left">
                <li>â€¢ Base network wallet (use MetaMask)</li>
                <li>â€¢ 20,000 NEYNARTODES tokens minimum</li>
                <li>â€¢ Season 0 whitelist (74 beta testers only)</li>
                <li>â€¢ Farcaster account (optional, for profile)</li>
              </ul>
            </div>

            <div class="mt-6 p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
              <p class="text-sm text-blue-800 mb-2 font-semibold">ğŸŒŠ Powered by ğŸŒŠ</p>
              <a href="https://dexscreener.com/base/0xfad8f807f3f300d594c5725adb8f54314d465bcb1ab8cc04e37b08c1aa80d2e7" target="_blank" class="text-purple-600 hover:text-pink-600 font-black text-lg transition-colors">
                $NEYNARTODES
              </a>
              <p class="font-mono text-xs text-gray-600 mt-2 break-all">${CONTRACTS.neynartodes}</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderMainPlatform() {
      const displayName = state.userProfile ? '@' + state.userProfile.username : state.userAddress.slice(0, 6) + '...' + state.userAddress.slice(-4);
      const fidText = state.userProfile ? 'FID: ' + state.userProfile.fid : '';
      const fidHTML = fidText ? '<span class="ml-2">' + fidText + '</span>' : '';

      return `
        <div class="min-h-screen bg-gradient-to-b from-blue-100 via-purple-100 to-pink-100 p-6">
          <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-400 via-pink-400 to-purple-500 rounded-2xl shadow-2xl p-5 mb-6 border-4 border-purple-300">
              <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                  <h1 class="text-3xl font-black text-white flex items-center gap-2 drop-shadow-lg">
                    ğŸ¦ Danng Neynartodes!! ğŸŒŠ
                  </h1>
                  <p class="text-sm text-purple-100 font-semibold">
                    ${displayName} ${fidHTML}
                  </p>
                  <p class="text-xs text-white font-bold mt-1 bg-purple-600 bg-opacity-50 inline-block px-3 py-1 rounded-full">
                    ğŸ¦ ${parseFloat(state.tokenBalance).toLocaleString()} $NEYNARTODES
                  </p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-xl px-4 py-2 text-white">
                  <p class="text-xs font-bold opacity-90">Season 0 Beta</p>
                  <p class="text-lg font-black">74 Testers</p>
                </div>
              </div>
            </div>

            <!-- Contract Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              <div class="bg-white rounded-xl shadow-lg p-4 border-2 border-purple-200">
                <p class="text-xs text-purple-600 font-bold mb-1">PrizeNFT Season 0</p>
                <p class="text-xs font-mono text-gray-600 break-all">${CONTRACTS.prizeNFT}</p>
              </div>
              <div class="bg-white rounded-xl shadow-lg p-4 border-2 border-pink-200">
                <p class="text-xs text-pink-600 font-bold mb-1">VotingManager Season 0</p>
                <p class="text-xs font-mono text-gray-600 break-all">${CONTRACTS.votingManager}</p>
              </div>
              <div class="bg-white rounded-xl shadow-lg p-4 border-2 border-blue-200">
                <p class="text-xs text-blue-600 font-bold mb-1">Captain Hook V2</p>
                <p class="text-xs font-mono text-gray-600 break-all">${CONTRACTS.captainHook}</p>
              </div>
              <div class="bg-white rounded-xl shadow-lg p-4 border-2 border-green-200">
                <p class="text-xs text-green-600 font-bold mb-1">Clanker Collector V2</p>
                <p class="text-xs font-mono text-gray-600 break-all">${CONTRACTS.clankerCollector}</p>
              </div>
            </div>

            <!-- Voting Power -->
            <div class="bg-gradient-to-r from-pink-100 to-purple-100 rounded-2xl shadow-xl p-6 border-4 border-purple-300 mb-6">
              <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                  <p class="font-black text-purple-800 text-lg">Your Voting Power Today:</p>
                  <p class="text-sm text-purple-700">Vote for your favorite beta testers!</p>
                </div>
                <div class="text-right">
                  <p class="text-4xl font-black text-purple-600">${state.votesRemaining}/10</p>
                  <p class="text-xs text-purple-700">Votes Left</p>
                </div>
              </div>
            </div>

            <!-- Leaderboard -->
            <div class="bg-white rounded-2xl shadow-2xl p-6 border-4 border-purple-300">
              <div class="flex items-center gap-3 mb-6">
                <span class="text-4xl">ğŸ“Š</span>
                <div>
                  <h2 class="text-3xl font-black text-purple-800">ğŸ¦ Season 0 Beta Testers ğŸ¦</h2>
                  <p class="text-sm text-purple-600 font-bold">74 Whitelisted Participants</p>
                </div>
              </div>

              ${state.isLoadingLeaderboard ? `
                <div class="text-center py-12">
                  <div class="text-6xl mb-4">ğŸŒ€</div>
                  <p class="text-xl font-bold text-purple-600">Loading participants from Neynar API...</p>
                </div>
              ` : `
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead>
                      <tr class="border-b-2 border-gray-200">
                        <th class="text-left py-3 px-2 font-semibold text-gray-700">Rank</th>
                        <th class="text-left py-3 px-2 font-semibold text-gray-700">User</th>
                        <th class="text-right py-3 px-2 font-semibold text-gray-700">FID</th>
                        <th class="text-right py-3 px-2 font-semibold text-gray-700">Followers</th>
                        <th class="text-right py-3 px-2 font-semibold text-gray-700">Following</th>
                        <th class="text-right py-3 px-2 font-semibold text-gray-700">Score</th>
                        <th class="text-center py-3 px-2 font-semibold text-gray-700">Vote</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${state.leaderboardData.slice(0, 20).map(user => {
                        const rankClass = user.rank <= 3 ? 'text-xl' : 'text-purple-600';
                        const rankDisplay = user.rank === 1 ? 'ğŸ‘‘' : user.rank === 2 ? 'ğŸ¥ˆ' : user.rank === 3 ? 'ğŸ¥‰' : '#' + user.rank;
                        const pfpHTML = user.pfp.startsWith('http') ?
                          '<img src="' + user.pfp + '" alt="' + user.username + '" class="w-8 h-8 rounded-full" />' :
                          '<span class="text-2xl">' + user.pfp + '</span>';
                        const displayNameHTML = user.displayName ? '<div class="text-xs text-gray-500">' + user.displayName + '</div>' : '';

                        return `
                        <tr class="border-b-2 border-purple-100 hover:bg-gradient-to-r hover:from-purple-50 hover:to-pink-50 transition-all">
                          <td class="py-4 px-2">
                            <div class="font-black text-lg ${rankClass}">
                              ${rankDisplay}
                            </div>
                          </td>
                          <td class="py-4 px-2">
                            <div class="flex items-center gap-2">
                              ${pfpHTML}
                              <div>
                                <div class="font-semibold text-gray-800">@${user.username}</div>
                                ${displayNameHTML}
                              </div>
                            </div>
                          </td>
                          <td class="py-4 px-2 text-right">
                            <div class="text-sm text-gray-600 font-mono">${user.fid}</div>
                          </td>
                          <td class="py-4 px-2 text-right">
                            <div class="font-semibold text-blue-600">${user.followers.toLocaleString()}</div>
                          </td>
                          <td class="py-4 px-2 text-right">
                            <div class="text-sm text-gray-600">${user.following.toLocaleString()}</div>
                          </td>
                          <td class="py-4 px-2 text-right">
                            <div class="font-bold text-purple-600 text-lg">${user.totalScore.toLocaleString()}</div>
                          </td>
                          <td class="py-4 px-2">
                            <div class="flex gap-1 justify-center">
                              <button
                                onclick="voteForHost(${user.fid}, true)"
                                ${state.votesRemaining <= 0 ? 'disabled' : ''}
                                class="p-2 bg-green-100 hover:bg-green-200 disabled:bg-gray-100 disabled:cursor-not-allowed rounded transition-colors text-lg"
                                title="Upvote (+5000 pts)"
                              >
                                ğŸ‘
                              </button>
                              <button
                                onclick="voteForHost(${user.fid}, false)"
                                ${state.votesRemaining <= 0 ? 'disabled' : ''}
                                class="p-2 bg-red-100 hover:bg-red-200 disabled:bg-gray-100 disabled:cursor-not-allowed rounded transition-colors text-lg"
                                title="Downvote (-5000 pts)"
                              >
                                ğŸ‘
                              </button>
                            </div>
                          </td>
                        </tr>
                      `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              `}

              <div class="mt-6 p-4 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl border-2 border-purple-300 text-center">
                <p class="font-black text-purple-800 text-lg">ğŸ‰ Season 0 Beta - Test Phase ğŸ‰</p>
                <p class="text-sm text-purple-700 mt-2">
                  Thank you for being one of our 74 whitelisted beta testers!
                </p>
                <p class="text-xs text-purple-600 mt-2">
                  All data loaded live from Neynar API âœ¨
                </p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderApp() {
      const html = state.isLoggedIn ? renderMainPlatform() : renderLoginScreen();
      document.getElementById('app').innerHTML = html;
    }

    // Initialize
    console.log('App loaded successfully!');
    renderApp();
  </script>
</body>
</html>
